---
title: 设计报告|大规模设备弹窗消息推送方案的设计与实现
date: 2023-06-28 13:56:06
tags: 设计报告
---

# 前言

# 一、需求背景与交互流程

## 需求背景

> 来源于 ChatGPT

App 弹窗推送是一种常见的应用程序通知方式，用于向用户发送重要信息、促销活动或其他相关内容。这种需求背景可以有多种原因，以下是几个常见的背景：

1. 重要通知和提醒：应用程序可能需要及时向用户发送重要通知和提醒，例如账户安全提示、系统更新、重要事件或活动等。弹窗推送能够以突出的方式吸引用户的注意力，确保用户能够及时获得关键信息。
2. 个性化推荐和促销：应用程序可能希望向用户发送个性化的推荐和促销信息，以提高用户参与度和用户体验。通过分析用户的兴趣、行为和偏好，应用程序可以针对性地发送相关内容的弹窗推送，从而增加用户的参与和转化率。
3. 用户参与和反馈：弹窗推送还可以用于促使用户参与调查、问卷调查、用户反馈等活动。应用程序可以使用弹窗推送来邀请用户参与活动或提供意见和建议，从而改进产品和服务。
4. 重要更新和新功能介绍：当应用程序进行重要更新或引入新功能时，弹窗推送可以用于向用户介绍和解释这些变化。这有助于提高用户对新功能的认知和使用，以及向用户传达应用程序的发展和改进。
5. 交易和订单状态更新：对于涉及交易和订单的应用程序（如电子商务应用、食品外卖应用等），弹窗推送可以用于向用户发送交易状态更新、订单确认、支付提醒等信息，以确保用户及时获得相关信息并保持交易的透明度。

总而言之，App 弹窗推送的需求背景通常是为了增强用户体验、提高用户参与度、促进交易和传达重要信息。这种方式能够直接地向用户呈现信息，并且相对于其他通知方式，更容易吸引用户的注意力和产生积极的反应。

## 交互流程

平台运营在 App 发布一些重要内容时保存发布的内容，然后扫描设备表推送开启弹窗推送开关的设备。推送过程中会判断登录用户的各类推送开关比如是否开启了免打扰模式，专栏文章开关等。推送内容到达用户设备时会弹窗展示推送标题和推送摘要，用户点击这条推送能跳转到指定的推送内容详情页。

# 二、大规模设备下的主要问题

## 推送延迟和限制

推送流程需要经历以下几个步骤：

1. 读取设备信息
2. 过滤用户自定义推送开关
3. 请求推送服务

当需要推送大规模的设备时，读取设备会比较耗时，例如数据库中有 100w 的设备，切分查询每次扫描 100 条记录，一次查询设备信息耗时 100ms，扫描完所有的记录总共耗时 1000s 大约 16.67 分钟。最后一次扫描的设备信息大约需要延迟 16.67 分钟才能收到推送，对于一些重要内容延迟到达用户体验非常不好。

频繁的推送或过于侵入性的推送可能会引起用户的不满，甚至导致用户关闭应用程序的通知权限。因此，应用程序需要在推送策略上进行谨慎考虑，确保推送内容的相关性和适度性，同时推送内容不能重复，以避免对用户造成打扰。用户可自定义推送开关来关闭不想接受的推送内容，对于大规模的设备推送除了需要扫描大表还需要过滤自定义开关，这无疑会导致推送延迟会更加严重。

## 高并发

## 消息丢失

扫描设备表全表信息时由于是单线程所以在发生 oom 或物理机宕机会导致所有的消息都丢失。todo

# 三、设计方案

为了解决以上问题主要采用了异步，非阻塞，分治，批量，集群等几个思路来优化系统性能。以发布内容为维度使用布隆过滤器来过滤大规模设备信息，保证这一条内容设备不收到重复推送。以发布内容生成唯一 id 一并推送给客户端，客户端使用唯一 id 保证在短时间内收到重复的推送内容覆盖弹窗消息而不是推送新的弹窗消息。
![](/images/design-report/device-push/process.png)
